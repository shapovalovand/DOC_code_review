# DOC_code_review

This is the documentation for the code review. Contains useful tips and best practices.
* Further documentation will be in Russian

---
## Полезные материалы:
<p>
  <a href="https://www.npmjs.com/package/eslint-config-airbnb">eslint-config-airbnb</a> 
  - три конфигурации ESLint от airbnb .
</p>
<p>
  <a href="https://github.com/airbnb/javascript">airbnb</a> 
  - руководство по стилю JavaScript.
</p>
<p>
  <a href="https://learn.javascript.ru/ninja-code">ninja-code</a> 
  - пример как не нужно оформлять код в JS.
</p>
<p>
  <a href="https://www.conventionalcommits.org/en/v1.0.0/">conventionalcommits</a> 
  - cпецификация для добавления удобочитаемого для человека и машины названий для коммитов.
</p>

---
#  Что такое код ревью? 

Основные понятия:
Код ревью (code review) - это часть процесса разработки продукта. В нем есть следующие участники:

* Автор - разработчик, который написал код. При этом любого объема, содержания и качества. Это может быть багфикс, фича

* Ревьюер - человек, который проверяет написанное, пишет замечания и возвращает код на доработку.
## Что нам даёт код ревью:

​- Проверку кода по многим критериям.

​- Автор не всегда видит неочевидные места в его коде (по разным причинам).

​- В результате написания и переписывания может быть потеряна композиция.

​- Автор, находясь в контексте задачи может недостаточно оставить комментариев.

Задача ревью не проверить всё на 100% - у вас это все равно не получится. Задача - иметь поддерживаемый, понятный и максимально “чистый” код.
- Ревьюер должен читать код
- Обращать внимание на композицию, магические переменные, оптимизацию (там где это имеет смысл)


---
>## Порядок просмотра MR

Сначала надо просмотреть MR в целом. Надо ли это вообще, в правильном ли месте код (или это должно быть в отдельной библиотеке), есть ли какие-то глобальные проблемы.
Т.е. нет смысла смотреть какие-то детали реализации, если код вообще не туда и не для того.

Вообще, порядок просмотра важен, чтобы как можно быстрее выдавать автору фидбек (смотри предыдущий пункт).

Когда посмотрели MR вцелом, надо пройтись по основным файлам, т.е. проверить самое главное (если непонятно, что самое главное, можно спросить у разработчика).

Опять же, о любых проблемах нужно сообщать сразу, даже если вы еще не досмотрели MR и решили вообще досмотреть его позже.

Далее надо выбрать логичную последовательность просмотра оставшихся файлов. Ни один файл не должен быть пропущен.

---
## На что обращать внимание при просмотре

- Код хорошо спроектирован
- Функциональность хорошо сделана с точки зрения пользователей этого кода, кем бы они ни были.
- Внешний вид (если есть) должен быть хорошим
- Учтены все нюансы параллельного программирования (если есть).
- Код не переусложнен
- Разработчик не оверинженирит: не нужно писать код, который может понадобиться, а может не понадобиться
- У кода есть тесты
- Тесты хорошо спроектированы
- Наименования (для всего) выбраны хорошо
- Комментарии к коду понятны и необходимы. Они должны объяснять, почему так сделано, а не как это сделано.
- Добавлена документация.
- Код соответствует стайл гайдам.
- читаем тикет, чекаем ручками что написанный код решает проблему
пробуем обмануть валидацию и проверить corner cases
- убеждаемся что лишние console.log убраны, и отсутствует закомментированный код
- используются let / const в зависимости от ситуации и не используется var
- нет лапшеобразного кода
- нет большого количества вложенных if
- места с возможными exceptions обернуты try / catch
- размер функций не должен превышать разумных пределов
- код разделен по компонентам, функциям, сервисам и тп
- код корректно отрабатывает в случае возникновения ошибок
Код ревью FE:
- если создан новый компонент, для него имеется соответствующий storybook / тест (если применимо)
- компонент ведет себя адекватно в разных браузерах на разных устройствах (если применимо)
Код ревью бекенда:
- обновлена документация / swagger / jsDoc (если применимо)
- написаны тесты unit / e2e (если применимо)
- добавлена соответствующая валидация
- миграции работают корректно как с пустой БД, так и с заполненной
- Код ревью тестов
- отсутствуют skip в тестах
- тесты покрывают corner cases

---
>## Идеальность MR

MR не должен быть идеальным, но он должен улучшать кодовую базу. Т.е с каждым привносимым изменением код должен становиться лучше и лучше. И если MR добавляет много хорошего, то не надо придираться к мелочам; выгоднее, чтобы это улучшение попало в код побыстрее.

Никакой MR не должен делать код хуже. Единственное исключение — это если MR является срочным фиксом чего-нибудь.

---
## MR должен быть маленьким, но самодостаточным

- Всё, что необходимо ревьюверу для понимания MR, должно быть в этом MR
- После вливания кода система должна функционировать нормально.
- Если добавляется метод API, в этом же MR должны быть продемонстрированы и способы его использования. Другими словами, MR не должен быть настолько - маленьким, чтобы трудо было понять как он будет использоваться, к каким последствиям приведет.
- Покрывайте код тестами, причем тесты должны быть в этом же MR

---
## Не отправлять огромные фрагменты кода на ревью

- Маленький MR можно быстро проверить
- Проверка будет более осмысленной
- Меньше вероятность упустить баг
- Не так обидно, если весь MR будет отклонен. Ведь очень плохо, когда сделана большая работа, а потом выясняется, что все это вообще было не нужно
- Проще вливать изменения, меньше конфликтов
- Легче добиться хорошего качества кода
- Чем больше изменений за раз, тем сложнее откатывать код при такой необходимости

---
- Дробить большие участки кода на несколько реквестов и вливать постепенно

Задачи бывают разными по объему. Может быть задача исправить 1 строчку кода, а может быть задача отрефакторить весь проект. Во втором случае не отправляйте реквест в котором исправлены 500 файлов и 4000 изменений. Никто в здравом уме не сможет это нормально проверить, и желания такое проверять вы тоже не найдете.

Чтобы избежать:

- Сделайте ветку feature/epic-name

- Изменения делайте в ветке feature/epic-name-implement

- Pull реквесты делайте в ветку feature/epic-name. Порционно.

- В конце реализации фичи подлейте feature/epic-name в мастер. Да, в этом случае пулл реквест тоже будет огромный, но всё уже будет заранее проверено

---
## Скорость проверки MR

Скорость экстремально важна. Если раз в несколько дней давать по одному комменту, то автор MR будет жаловаться, что к нему придираются и не дают работать.

Если MR проверяется очень быстро, то любые замечания не будут являться большой проблемой — ведь их фиксы тут проверят, и таск пройдет дальше.

---
## Описание MR

В Google описание изменений сохраняется в истории системы контроля версий, и с большой вероятностью его будут читать очень много людей в будущем. Поэтому описание MR очень важно.


В первой строчке (в заголовке) должно быть одной фразой описано, что было сделано в MR. Причем по традиции применяется императивный (повелительный) стиль, т.е. Delete blablabla, а не Deleting blablabla


Само описание должно быть информативным, содержать краткое описание решаемой проблемы, ссылки на необходимые документы (если необходимо), задачи таск трекера и другой контекст. Даже в маленьком MR что-то такое должно быть.


Описание типа "Fix bug", понятное дело, считается неадекватным.

---

> ## Правила общения и поведения на ревью
---

Ваша задача, как ревьюера, получить такой код, который в случае болезни разработчика вы завтра будете поддерживать и не потонете. Задача автора - писать код, который как будто будет поддерживать маньяк, который знает где живет автор

- Агрессия, негатив, «токсичное» поведение в комментах - запрещено
- Старайтесь отмечать не только негативные стороны, но и хвалить за позитивные.
- Нужно быть вежливым, не переходить на личности. Обсуждать код, а не кодера.
- Не просто выдавать директивы к исправлениям, а объяснять, почему нужно исправить.
- Соблюдать баланс: обозначить проблему и подтолкнуть разработчика, чтобы он сам понял, как лучше ее решить; или же сразу выдать готовое решение. Первое развивает разработчика (стратегическая выгода), второе улучшает и ускоряет MR (тактическая выгода).
- Если ревьювер не понял какой-то момент в коде и просит автора объяснить, что к чему, то лучшим ответом будет изменение кода. Так, чтобы было по коду все было понятно без вопросов.

---
## Не принимайте близко к сердцу

Иногда ревьюверы ведут себя не очень вежливо, могут написать что-нибудь плохое про ваш код. Это не очень профессионально с их стороны, однако зачастую зерно истины в таких комментариях всё же есть, и это надо учитывать. Не отвечайте слишком резко. Это только усугубит ситуацию.

В случае, если вам не нравится тон разговора в комментариях, лучше найти этого человека и пообщаться с ним лично, объяснить, что вас не устраивает.

Если и это не помогло, Гугл советует обратиться к менеджеру.

---
## Объясняйте кодом

Если вас просят объяснить какой-то момент в коде, подумайте, нельзя ли поправить код так, чтобы он был понятен без объяснений. Потому что если один не понял, то и другие могут не понять.

---
## Реакция на комментарии ревьювера

Зачастую, когда работа сделана и отправлена на код ревью, психологически довольно сложно принять тот факт, что придется еще и что-то исправлять. Поэтому постарайтесь не воспринимать комментарии ревьювера в штыки, подумайте, возможно он прав, и код станет в результате лучше.

## Примеры плохих комментов:
```
- «это плохой код», «перепиши»
```

## Примеры хороших комментов:

```
- «Давай попробуем сделать …» «Может попробуем вынести…»
```

То же самое касается и ответов на комменты автором. Если автор не согласен, то необходимо объяснять с помощью аргументов, а не фраз в духе "я так делать не буду". Если не получается текстом, иногда проще подойти или сделать короткий созвон, чтобы понять друг друга.

- Все комментарии не обязательны к исправлению 
- Помечать необязательные комментарии

В замечаниях могут быть необязательные правки - например вкусовщина, или замечания, требующие большую переработку кода. Такие комментарии обязательно помечайте.

​- Пытаться объяснить алгоритмы на словах

​- Написать пример псевдокода

Особенно актуально, если автор не совсем понимает что от него хочет ревьюер. Не нужно полностью писать реализацию. Напишите небольшой пример псевдокода. Gitlab, github и bitbucket позволяют вставлять в комментарии разметку markdown. Ваш код будет хорошо отформатирован и более понятен, чем длинная цепочка комментов.

---
## Если ревьювер и автор MR не согласны друг с другом

Сначала идет попытка достигнуть консенсуса в комментариях к MR. Если это не получается, то личное обсуждение. Если все равно не пришли к единому мнению, то привлекать членов команды. Но главное, MR не должен застревать надолго из-за несогласия двух человек.

Обсудили в коментах -> Обсудили лично -> Обсудили в команде -> Двигаемся дальше

---
## Свобода делать замечания

Несмотря на то, что нельзя задалбывать мелочами, тем не менее можно свободно эти мелочи писать хоть к каждой строчке. Мелочи и придирки ревьювер помечает префиксом "nit:" от англ. nitpick (придирка). Такие замечания фиксить необязательно, однако автор MR может захотеть что-то исправить или, даже если нет, учесть на будущее некоторые моменты.

---
## Если с вашим мнением не согласны

Нужно разобраться детально. Возможно, вы чего-то не понимаете, запросите больше информации. Возможно наоборот. В любом случае, зачастую понимание приходит только после пары раундов объяснений с обеих сторон.

---
## Боязнь расстроить автора MR

Бывает, что разработчик расстраивается, если ревьювер настаивает на каких-то изменениях. Однако, чаще всего разработчики расстраиваются из-за формы замечания, а не из-за содержания. Будьте вежливы, объясняйте аргументами, и скорее всего всё будет ок.

---
## "Я исправлю это потом"

Если разработчик согласен с тем, что в коде есть проблема, но просит заапрувить MR, обещая, что исправит это в другой раз, то, по мнению ребят из Гугла, это "потом" чаще всего никогда не наступает. Поэтому если MR — не какой-то срочный багфикс прода, то нужно настаивать на исправлении.

---
